{% extends "layouts/base.html" %}
{% block header_title %}
  Scan QR Code - {{ scanner.name }}
{% endblock header_title %}
{% block content %}
  <div class="container mx-auto mt-10">
    <div class="flex justify-center">
      <div id="qr-reader" class="w-full mx-auto max-w-[500px]"></div>
    </div>
    <div id="qr-reader-results" class="mt-5 text-center"></div>
  </div>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
    function onScanSuccess(decodedText, decodedResult) {
      console.log(`Code scanned = ${decodedText}`, decodedResult);
      // Handle the scanned code as you like, for example:
      document.getElementById('qr-reader-results').innerText = decodedText;

      // Send the data to your Django view
      fetch('/scan_data/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ qr_data: decodedText, scanner_name: '{{ scanner.name }}' })
      })
      .then(response => response.text())
      .then(data => {
        document.getElementById('qr-reader-results').innerText = data;
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('qr-reader-results').innerText = 'Error scanning QR code.';
      });
    }

    function onScanFailure(error) {
      console.warn(`Code scan error = ${error}`);
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
      "qr-reader", { fps: 10, qrbox: 250 }
    );
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
  </script>
{% endblock content %}
